<!DOCTYPE html>
<html>
    <head>
        <title>Unclear Throne</title>
        <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
        <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    </head>
    <body>
        <canvas width="800" height="600" id="gameCanvas" style="cursor: none; image-rendering: pixelated;"></canvas>
        <script>

/** THE GAME ITSELF **********************************************************/
var TSZ = 40; // Tile size
var MSZ = 50; // Map size
var NOTICE_RANGE = 550;
var PURSUE_RANGE = 700;

var ammoTypes = {
    bullets: {
        id: "bullets",
        name: "Bullets",
        drop: {x:3, y:123, w:12, h:14},
        indicator: {x:1, y:141, w:18, h:8},
        max: 200,
        pickup: 24
    },
    grenades: {
        id: "grenades",
        name: "Grenades",
        drop: {x:3, y:123, w:12, h:14},
        indicator: {x:1, y:149, w:8, h:8},
        max: 10,
        pickup: 2
    },
    energy: {
        id: "energy",
        name: "Abyssal Energy",
        drop: {x:3, y:123, w:12, h:14},
        indicator: {x:11, y:149, w:8, h:8},
        max: 1000,
        pickup: 100
    }
};

var weaponTypes = {
    slowSixShooter: {
        img: {x:0, y:80, w:14, h:7},
        shot: {x:26, y:81, w:9, h:5},
        reload: 2400,
        numShots: 1,
        dmg: 2,
        range: 300,
        speed: 0.4,
        jitter: 0.05,
        blastRadius: 0,
        bounce: false,
        fuze: 0,
        ammo: null
    },
    sixShooter: {
        name: "Six-Shooter",
        img: {x:0, y:80, w:14, h:7},
        shot: {x:16, y:81, w:9, h:5},
        reload: 500,
        numShots: 1,
        dmg: 2,
        range: 450,
        speed: 1.0,
        jitter: 0.05,
        blastRadius: 0,
        bounce: false,
        fuze: 0,
        ammo: "bullets"
    },
    rageShooter: {
        name: "Rage!!!",
        img: {x:0, y:80, w:14, h:7},
        shot: {x:16, y:81, w:9, h:5},
        reload: 150,
        numShots: 1,
        dmg: 2,
        range: 450,
        speed: 1.5,
        jitter: 0.3,
        blastRadius: 0,
        bounce: false,
        fuze: 0,
        ammo: null
    },
    spurSpike: {
        img: {x:0, y:0, w:0, h:0},
        shot: {x:15, y:112, w:18, h:8},
        reload: 3000,
        numShots: 1,
        dmg: 2,
        range: 80,
        speed: 1,
        jitter: 0,
        blastRadius: 0,
        bounce: false,
        fuze: 0,
        ammo: null
    },
    rifle: {
        name: "Rifle",
        img: {x:0, y:90, w:32, h:10},
        shot: {x:16, y:81, w:9, h:5},
        reload: 1000,
        numShots: 1,
        dmg: 3,
        range: 700,
        speed: 1.6,
        jitter: 0.01,
        blastRadius: 0,
        bounce: false,
        fuze: 0,
        ammo: "bullets"
    },
    shotgun: {
        name: "Shotgun",
        img: {x:0, y:102, w:27, h:10},
        shot: {x:16, y:81, w:9, h:5},
        reload: 1500,
        numShots: 5,
        dmg: 1,
        range: 200,
        speed: 0.8,
        jitter: 0.2,
        blastRadius: 0,
        bounce: false,
        fuze: 0,
        ammo: "bullets"
    },
    bowieKnife: {
        name: "Bowie Knife",
        img: {x:54, y:107, w:17, h:6},
        shot: {x:54, y:107, w:17, h:6},
        reload: 500,
        numShots: 1,
        dmg: 8,
        range: 40,
        speed: 2,
        jitter: 0,
        blastRadius: 0,
        bounce: false,
        fuze: 0,
        ammo: null
    },
    horseshoe: {
        img: {x:30, y:101, w:8, h:9},
        shot: {x:30, y:101, w:8, h:9},
        reload: 2000,
        numShots: 1,
        dmg: 3,
        range: 70,
        speed: 1,
        jitter: 0.2,
        blastRadius: 0,
        bounce: false,
        fuze: 0,
        ammo: null
    },
    gatlingGun: {
        name: "Gatling Gun",
        img: {x:41, y:81, w:37, h:11},
        shot: {x:16, y:81, w:9, h:5},
        reload: 200,
        numShots: 1,
        dmg: 2,
        range: 500,
        speed: 1.2,
        jitter: 0.1,
        blastRadius: 0,
        bounce: false,
        fuze: 0,
        ammo: "bullets"
    },
    grenades: {
        name: "Grenades",
        img: {x:41, y:107, w:9, h:9},
        shot: {x:41, y:107, w:9, h:9},
        reload: 1000,
        numShots: 1,
        dmg: 6,
        range: 300,
        speed: 0.2,
        jitter: 0.05,
        blastRadius: 50,
        bounce: true,
        fuze: 1300,
        ammo: "grenades"
    },
    slowGatlingGun: {
        img: {x:41, y:81, w:37, h:11},
        shot: {x:26, y:81, w:9, h:5},
        reload: 200,
        numShots: 1,
        dmg: 1,
        range: 500,
        speed: 0.5,
        jitter: 0.15,
        blastRadius: 0,
        bounce: false,
        fuze: 0,
        ammo: null
    },
    abyssalProjector: {
        name: "Abyssal Projector",
        img: {x:41, y:94, w:30, h:11},
        shot: {x:74, y:96, w:5, h:5},
        reload: 50,
        numShots: 1,
        dmg: 1,
        range: 500,
        speed: 0.6,
        jitter: 0,
        blastRadius: 0,
        bounce: false,
        fuze: 0,
        ammo: "energy"
    },
    abyssalInvoker: {
        name: "Abyssal Invoker",
        img: {x:44, y:121, w:15, h:16},
        shot: {x:74, y:96, w:5, h:5},
        reload: 350,
        numShots: 1,
        dmg: 1,
        range: 600,
        speed: 0.8,
        jitter: 0,
        blastRadius: 0,
        bounce: false,
        fuze: 0,
        ammo: "energy"
    }
};

var droppableWeapons = [weaponTypes.rifle, weaponTypes.shotgun, weaponTypes.bowieKnife, weaponTypes.gatlingGun, weaponTypes.abyssalProjector, weaponTypes.grenades, weaponTypes.abyssalInvoker];

var enemyTypes = {
    blackHat: {
        img: {x: 3*TSZ, y: 1*TSZ, w: TSZ, h: TSZ},
        speed: 0.2,
        hp: 3,
        weapon: weaponTypes.slowSixShooter,
        dropP: 0.3
    },
    tumbleweed: {
        img: {x: 4*TSZ, y: 1*TSZ, w: TSZ, h: TSZ},
        speed: 0.4,
        hp: 1,
        weapon: weaponTypes.slowSixShooter,
        dropP: 0.5
    },
    angryPony: {
        img: {x: 5*TSZ, y: 1*TSZ, w: TSZ, h: TSZ},
        speed: 0.3,
        hp: 3,
        weapon: weaponTypes.horseshoe,
        dropP: 0.8
    },
    train: {
        img: {x: 6*TSZ, y: 1*TSZ, w: TSZ, h: TSZ},
        speed: 0.1,
        hp: 12,
        weapon: weaponTypes.slowGatlingGun,
        dropP: 1.0
    }
};

var levels = [
    {
        name: "Black Hats and Tumbleweeds",
        img: {x: 320, y:320, w:160, h:160},
        blackHat: 12,
        tumbleweed: 3,
        weaponDrops: 2
    },
    {
        name: "Angry Ponies",
        img: {x: 0, y:320, w:160, h:160},
        blackHat: 8,
        tumbleweed: 8,
        angryPony: 4,
        weaponDrops: 2
    },
    {
        name: "T.R.A.I.N, the evil cousin of S.P.U.R",
        img: {x: 160, y:320, w:160, h:160},
        blackHat: 5,
        tumbleweed: 10,
        angryPony: 5,
        train: 1,
        weaponDrops: 2
    }
];

var tileTypes = {
    dirt0: {
        img: {x: 0, y: 0, w: TSZ, h: TSZ},
        dy: 0,
        wall: false
    },
    dirt1: {
        img: {x: 12*TSZ, y: 0, w: TSZ, h: TSZ},
        dy: 0,
        wall: false
    },
    dirt2: {
        img: {x: 13*TSZ, y: 0, w: TSZ, h: TSZ},
        dy: 0,
        wall: false
    },
    dirt3: {
        img: {x: 14*TSZ, y: 0, w: TSZ, h: TSZ},
        dy: 0,
        wall: false
    },
    dirt4: {
        img: {x: 15*TSZ, y: 0, w: TSZ, h: TSZ},
        dy: 0,
        wall: false
    },
    dirtWall: {
        img: {x: 7*TSZ, y: 0, w: TSZ, h: TSZ*2},
        dy: -TSZ,
        wall: true
    },
    barrel: {
        img: {x: 2*TSZ, y: 0, w: TSZ, h: TSZ},
        dy: 0,
        wall: true
    },
    fence: {
        img: {x: 3*TSZ, y: 0, w: TSZ, h: TSZ},
        dy: 0,
        wall: false
    },
    skull: {
        img: {x: 4*TSZ, y: 0, w: TSZ, h: TSZ},
        dy: 0,
        wall: false
    },
    cactus: {
        img: {x: 5*TSZ, y: 0, w: TSZ, h: TSZ},
        dy: 0,
        wall: true
    },
    flower: {
        img: {x: 6*TSZ, y: 0, w: TSZ, h: TSZ},
        dy: 0,
        wall: false
    },
    cross: {
        img: {x: 8*TSZ, y: 0, w: TSZ, h: TSZ},
        dy: 0,
        wall: false
    },
    wheel: {
        img: {x: 9*TSZ, y: 0, w: TSZ, h: TSZ},
        dy: 0,
        wall: false
    },
    well: {
        img: {x: 10*TSZ, y: 0, w: TSZ, h: TSZ},
        dy: 0,
        wall: true
    },
    stone: {
        img: {x: 11*TSZ, y: 0, w: TSZ, h: TSZ},
        dy: 0,
        wall: false
    }
};

var abilities = {
    gunslinger: {
        id: "gunslinger",
        name: "Gunslinger",
        desc0: "Faster shots",
        desc1: ""
    },
    deathTrickPony: {
        id: "deathTrickPony",
        name: "Deathpony",
        desc0: "Ability kills",
        desc1: "grant items"
    },
    thickHide: {
        id: "thickHide",
        name: "Thick Hide",
        desc0: "Enemy shots hurt",
        desc1: "less"
    },
    arsenal: {
        id: "arsenal",
        name: "Arsenal",
        desc0: "A bunch of ammo",
        desc1: ""
    },
    mayhem: {
        id: "mayhem",
        name: "Mayhem",
        desc0: "Kill streaks",
        desc1: "grant HP"
    },
    scavenger: {
        id: "scavenger",
        name: "Scavenger",
        desc0: "Items stay around",
        desc1: "longer"
    },
    rosyCheeks: {
        id: "rosyCheeks",
        name: "Rosy Cheeks",
        desc0: "2 HP at the start",
        desc1: "of each level"
    }
};

var abilityNames = ["gunslinger", "deathTrickPony", "thickHide", "arsenal", "mayhem", "scavenger", "rosyCheeks"];

var playerTypes = [
    {
        name: "Taquito James",
        desc1: "Ability: Rage",
        desc0: "More XP",
        img: {x: 0, y: 1*TSZ, w: TSZ, h: TSZ},
        large: {x: 0, y:160, w:160, h:160},
        hp: 6,
        speed: 0.25,
        xpMult: 2
    },
    {
        name: "El Gato",
        desc1: "Ability: Leap",
        desc0: "More HP",
        img: {x: TSZ, y: 1*TSZ, w: TSZ, h: TSZ},
        large: {x: 160, y:160, w:160, h:160},
        hp: 9,
        speed: 0.25,
        xpMult: 1
    },
    {
        name: "S.P.U.R",
        desc1: "Ability: Whirl",
        desc0: "Faster",
        img: {x: 2*TSZ, y: 1*TSZ, w: TSZ, h: TSZ},
        large: {x: 320, y:160, w:160, h:160},
        hp: 6,
        speed: 0.4,
        xpMult: 1
    }
];

var playerSelect = true;
var levelIntro = true;
var victory = false;
var levelUp = false;
var availableAbilities = [];
var player = null;
var gunSwitchDelay = 0;
var gunTakeDelay = 0;
var level = 0;

function createPlayer(type) {
    player = {
        type: type,
        weapon: weaponTypes.sixShooter,
        offHand: null,
        offHandRaging: null,
        abilities: {},
        ammo: {
            bullets: 80,
            grenades: 0,
            energy: 0
        },
        xp: 2,
        level: 1,
        reload: 0,
        x: MSZ * TSZ / 2,
        y: MSZ * TSZ / 2,
        hp: type.hp,
        rageMeter: 0,
        mayhemMeter: 0,
        abilityCooldown: 0,
        leaping: 1000,
        leapDx: 0,
        leapDy: 0
    };
}

var map = [];
var enemies = [];

function splort(x, y, r) {
    for (var xx = x - r; xx < x + r; xx++) { for (var yy = y - r; yy < y + r; yy++) {
        if (xx < 0 || xx >= MSZ || yy < 0 || yy >= MSZ) { continue; }
        if ((xx - x) * (xx - x) + (yy - y) * (yy - y) <= r * r) {
            map[yy][xx] = tileTypes["dirt" + Math.floor(Math.random() * 5)];
        }
    }}
}

function canSplort(x, y, r) {
    var connected = 0;
    for (var xx = x - r; xx < x + r; xx++) { for (var yy = y - r; yy < y + r; yy++) {
        if (xx < 1 || xx >= MSZ - 1 || yy < 1 || yy >= MSZ - 1) { return false; }
        if ((xx - x) * (xx - x) + (yy - y) * (yy - y) <= r * r && !map[yy][xx].wall) {
            connected++;
        }
    }}
    return connected > 0 && connected < r * r / 4;
}

function splortRect(x, y, w, h) {
    for (var xx = x; xx < x + w; xx++) { for (var yy = y; yy < y + h; yy++) {
        map[yy][xx] = tileTypes["dirt" + Math.floor(Math.random() * 5)];
    }}
}

function canSplortRect(x, y, w, h) {
    var connected = 0;
    for (var xx = x; xx < x + w; xx++) { for (var yy = y; yy < y + h; yy++) {
        if (xx < 1 || xx >= MSZ - 1 || yy < 1 || yy >= MSZ - 1) { return false; }
        if (!map[yy][xx].wall) {
            connected++;
        }
    }}
    return connected > 0 && connected < 9;
}

function wallProportion() {
    var wall = 0;
    for (var y = 0; y < MSZ; y++) { for (var x = 0; x < MSZ; x++) {
        if (map[y][x].wall) { wall++; }
    }}
    return wall * 1.0 / MSZ / MSZ;
}

function generateMap() {
    map = new Array(MSZ);
    enemies = [];
    particles = [];
    drops = [];
    droppedWeapons = [];
    shots = [];
    player.x = MSZ * TSZ / 2;
    player.y = MSZ * TSZ / 2;
    for (var i = 0; i < MSZ; i++) {
        map[i] = new Array(MSZ);
    }
    for (var y = 0; y < MSZ; y++) { for (var x = 0; x < MSZ; x++) {
        map[y][x] = tileTypes.dirtWall;
    }}
    splort(MSZ / 2, MSZ / 2, 1);
    while (wallProportion() > 0.7) {
        var x = Math.floor(Math.random() * MSZ);
        var y = Math.floor(Math.random() * MSZ);
        var w = 5 + Math.ceil(Math.random() * 7);
        var h = 2;
        if (canSplortRect(x, y, w, h)) { splortRect(x, y, w, h); }
        x = Math.floor(Math.random() * MSZ);
        y = Math.floor(Math.random() * MSZ);
        w = 2;
        h = 5 + Math.ceil(Math.random() * 7);
        if (canSplortRect(x, y, w, h)) { splortRect(x, y, w, h); }
        x = Math.floor(Math.random() * MSZ);
        y = Math.floor(Math.random() * MSZ);
        var r = Math.ceil(Math.random() * 7);
        if (canSplort(x, y, r)) { splort(x, y, r); }
    }
    // Barrels, cacti, wells
    for (var i = 0; i < MSZ * MSZ / 60; i++) {
        var x = Math.floor(Math.random() * MSZ);
        var y = Math.floor(Math.random() * MSZ);
        if (!map[y][x].wall) {
            var nearWall = false;
            for (var dy = -1; dy < 2; dy++) { for (var dx = -1; dx < 2; dx++) {
                nearWall |= map[y + dy][x + dx].wall;
            }}
            if (!nearWall) {
                map[y][x] = [tileTypes.barrel, tileTypes.cactus, tileTypes.well][Math.floor(Math.random() * 3)];
            }
        }
    }
    // Terrain features
    for (var i = 0; i < MSZ * MSZ / 20; i++) {
        var x = Math.floor(Math.random() * MSZ);
        var y = Math.floor(Math.random() * MSZ);
        if (!map[y][x].wall) {
            map[y][x] = [tileTypes.fence, tileTypes.skull, tileTypes.flower, tileTypes.cross, tileTypes.wheel, tileTypes.stone][Math.floor(Math.random() * 6)];
        }
    }
    var placedWeapons = 0;
    while (placedWeapons < levels[level].weaponDrops) {
        var x = Math.random() * MSZ * TSZ;
        var y = Math.random() * MSZ * TSZ;
        if (wallAt(x, y) || wallAt(x + TSZ, y) || wallAt(x, y + TSZ) || wallAt(x + TSZ, y + TSZ)) {
            continue;
        }
        placedWeapons++;
        var weaponType = droppableWeapons[Math.floor(Math.random() * droppableWeapons.length)];
        droppedWeapons.push({
            type: weaponType,
            x: x,
            y: y
        });
        if (weaponType.ammo) {
            drops.push({
                type: "ammo",
                img: ammoTypes[weaponType.ammo].drop,
                ammoType: ammoTypes[weaponType.ammo],
                x: x,
                y: y,
                life: 1000000,
            });
        }
    }
    var typeNames = ["blackHat", "tumbleweed", "angryPony", "train"];
    for (var i = 0; i < typeNames.length; i++) {
        var typeName = typeNames[i];
        var type = enemyTypes[typeName];
        var placed = 0;
        while (placed < levels[level][typeName]) {
            var x = Math.random() * MSZ * TSZ;
            var y = Math.random() * MSZ * TSZ;
            if (wallAt(x, y) || wallAt(x + TSZ, y) || wallAt(x, y + TSZ) || wallAt(x + TSZ, y + TSZ)) {
                continue;
            }
            if ((x - MSZ * TSZ / 2) * (x - MSZ * TSZ / 2) + (y - MSZ * TSZ / 2) * (y - MSZ * TSZ / 2) < 300 * 300) {
                continue;
            }
            placed++;
            enemies.push({
                type: type,
                x: x,
                y: y,
                reload: Math.floor(type.weapon.reload * Math.random()),
                hp: type.hp,
                noticed: false,
                moveWait: 0,
                stun: 1000,
                lastHitBySpecialMove: false
            });
        }
    }
}

var shots = [];
var particles = [];
var drops = [];
var droppedWeapons = [];

function doDrop(x, y) {
    switch (Math.floor(Math.random() * 7)) {
        case 0: case 1:
            drops.push({
                type: "hp",
                img: {x:16, y:123, w:12, h:14},
                x: x,
                y: y,
                life: player.abilities.scavenger ? 60000 : 5000
            });
            break;
        case 2: case 3:
            drops.push({
                type: "xp",
                img: {x:30, y:124, w:10, h:10},
                x: x,
                y: y,
                life: player.abilities.scavenger ? 60000 : 5000
            });
            break;
        case 4: case 5: case 6:
            var ammoType = [ammoTypes.bullets, ammoTypes.bullets, ammoTypes.grenades, ammoTypes.energy][Math.floor(Math.random() * 4)];
            drops.push({
                type: "ammo",
                img: ammoType.drop,
                ammoType: ammoType,
                x: x,
                y: y,
                life: player.abilities.scavenger ? 60000 : 5000
            });
            break;
    }
}

function canHit(weapon, shooter, sx, sy, tx, ty) {
    var angle = Math.atan2(ty - sy, tx - sx);
    var c = Math.cos(angle);
    var s = Math.sin(angle);
    var x = sx;
    var y = sy;
    for (var i = 0; i < weapon.range; i += 5) {
        x += c * 5;
        y += s * 5;
        if (wallAt(x, y)) {
            return false;
        }
    }
    return true;
}

function shoot(weapon, x, y, angle, byPlayer) {
    var speedMult = byPlayer && player.abilities.gunslinger ? 1.8 : 1.0;
    for (var i = 0; i < weapon.numShots; i++) {
        var angle2 = angle + (Math.random() * 2 - 1) * weapon.jitter;
        shots.push({
            weapon: weapon,
            srcX: x,
            srcY: y,
            x: x,
            y: y,
            dx: Math.cos(angle2) * weapon.speed * speedMult,
            dy: Math.sin(angle2) * weapon.speed * speedMult,
            angle: angle2,
            byPlayer: byPlayer,
            fuze: weapon.fuze
        });
    }
}

function wallAt(x, y) {
    x = Math.floor(x / TSZ);
    y = Math.floor(y / TSZ);
    return x < 0 || x >= MSZ || y < 0 || y >= MSZ || map[y][x].wall;
}

function obstacleAt(x, y, self) {
    if (self != player) {
        if (x >= player.x + 5 && y >= player.y + 5 && x < player.x + TSZ - 5 && y < player.y + TSZ - 5) {
            return player;
        }
    }
    for (var i = 0; i < enemies.length; i++) {
        var enemy = enemies[i];
        if (enemy == self) { continue; }
        if (x >= enemy.x + 5 && y >= enemy.y + 5 && x < enemy.x + TSZ - 5 && y < enemy.y + TSZ - 5) {
            return enemy;
        }
    }
    return null;
}

function unitObstacleAt(x, y, self) {
    return obstacleAt(x + 5, y + 5, self) || obstacleAt(x + TSZ - 5, y + 5, self) || obstacleAt(x + 5, y + TSZ - 5, self) || obstacleAt(x + TSZ - 5, y + TSZ - 5, self);
}

function input(ms) {
    if (playerSelect) {
        for (var i = 0; i < playerTypes.length; i++) {
            var pt = playerTypes[i];
            if (click && click.x >= 115 + i * 200 && click.x <= 115 + i * 200 + 170 && click.y >= 270 && click.y <= 270 + 290) {
                createPlayer(pt);
                generateMap();
                playerSelect = false;
                levelIntro = true;
            }
        }
        click = null;
        return;
    }
    if (levelUp) {
        for (var i = 0; i < availableAbilities.length; i++) {
            var ab = availableAbilities[i];
            if (click && click.x >= 115 + i * 200 && click.x <= 115 + i * 200 + 170 && click.y >= 270 && click.y <= 270 + 290) {
                player.abilities[ab] = 1;
                if (ab == "arsenal") {
                    player.ammo.bullets = Math.min(ammoTypes.bullets.max, player.ammo.bullets + ammoTypes.bullets.max / 2);
                    player.ammo.grenades = Math.min(ammoTypes.grenades.max, player.ammo.grenades + ammoTypes.grenades.max / 2);
                    player.ammo.energy = Math.min(ammoTypes.energy.max, player.ammo.energy + ammoTypes.energy.max / 2);
                }
                levelUp = false;
            }
        }
        click = null;
        return;
    }
    if (victory) {
        if (click) {
            victory = false;
            playerSelect = true;
            level = 0;
        }
        return;
    }
    if (levelIntro) {
        if (click) {
            levelIntro = false;
        }
        return;
    }

    if (player.leaping == 0) {
        if (down("W") && !wallAt(player.x + 5, player.y - player.type.speed * ms) && !wallAt(player.x + TSZ - 5, player.y - player.type.speed * ms) && unitObstacleAt(player.x, player.y - player.type.speed * ms, player) == null) {
            player.y -= player.type.speed * ms;
        }
        if (down("S") && !wallAt(player.x + 5, player.y + TSZ + player.type.speed * ms) && !wallAt(player.x + TSZ - 5, player.y + TSZ + player.type.speed * ms) && unitObstacleAt(player.x, player.y + player.type.speed * ms, player) == null) { 
            player.y += player.type.speed * ms;
        }
        if (down("A") && !wallAt(player.x - player.type.speed * ms, player.y + 5) && !wallAt(player.x - player.type.speed * ms, player.y + TSZ - 5) && unitObstacleAt(player.x - player.type.speed * ms, player.y, player) == null) { 
            player.x -= player.type.speed * ms;
        }
        if (down("D") && !wallAt(player.x + TSZ + player.type.speed * ms, player.y + 5) && !wallAt(player.x + TSZ + player.type.speed * ms, player.y + TSZ - 5) && unitObstacleAt(player.x + player.type.speed * ms, player.y, player) == null) { 
            player.x += player.type.speed * ms;
        }
    }
    if (down("E") && gunTakeDelay == 0) {
        for (var i = 0; i < droppedWeapons.length; i++) {
            var droppedWeapon = droppedWeapons[i];
            if (droppedWeapon.type != player.weapon && droppedWeapon.type != player.offHand && (player.x + TSZ / 2 - droppedWeapon.x) * (player.x + TSZ / 2 - droppedWeapon.x) + (player.y + TSZ / 2 - droppedWeapon.y) * (player.y + TSZ / 2 - droppedWeapon.y) < 25 * 25) {
                if (player.offHand == null) {
                    player.offHand = player.weapon;
                } else {
                    droppedWeapons.push({
                        type: player.weapon,
                        x: player.x + TSZ / 2,
                        y: player.y + TSZ / 2
                    });
                }
                player.weapon = droppedWeapon.type;
                droppedWeapons.splice(i, 1);
                gunTakeDelay = 500;
                break;
            }
        }
    }
    if (down("Q") && player.offHand && gunSwitchDelay == 0 && !(player.type.name == "Taquito James" && player.abilityCooldown > 0)) {
        var tmp = player.weapon;
        player.weapon = player.offHand;
        player.offHand = tmp;
        gunSwitchDelay = 500;
    }
    if (down(" ") && player.abilityCooldown == 0) {
        switch (player.type.name) {
            case "S.P.U.R":
                player.abilityCooldown = 500;
                for (var i = 0; i < 12; i++) {
                    var angle = i * Math.PI / 6;
                    shoot(
                        weaponTypes.spurSpike,
                        player.x + TSZ / 2,
                        player.y + TSZ / 2,
                        angle,
                        true);
                }
                break;
            case "El Gato":
                player.abilityCooldown = 1000;
                var angle = Math.atan2(cursor.y - canvas.height / 2, cursor.x - canvas.width / 2);
                player.leaping = 1000;
                player.leapDx = Math.cos(angle);
                player.leapDy = Math.sin(angle);
                break;
            case "Taquito James":
                player.abilityCooldown = 10000;
                player.rageMeter = 0;
                break;
        }
    }
    if (player.type.name == "Taquito James" && player.abilityCooldown > 0) {
        if (player.weapon != weaponTypes.rageShooter) {
            player.offHandRaging = player.weapon;
            player.weapon = weaponTypes.rageShooter;
        }
    } else if (player.weapon == weaponTypes.rageShooter) {
        player.weapon = player.offHandRaging;
    }
    if ((mouseDown || (player.type.name == "Taquito James" && player.abilityCooldown > 0)) && player.reload == 0 && (player.weapon.ammo == null || player.ammo[player.weapon.ammo])) {
        player.reload = player.weapon.reload;
        if (player.weapon.ammo) {
            player.ammo[player.weapon.ammo]--;
        }
        var angle = Math.atan2(cursor.y - canvas.height / 2, cursor.x - canvas.width / 2);
        shoot(
            player.weapon,
            player.x + TSZ / 2 + Math.cos(angle) * player.weapon.img.w / 2 - Math.sin(angle) * player.weapon.img.h / 2,
            player.y + TSZ / 2 + Math.sin(angle) * player.weapon.img.w / 2 + Math.cos(angle) * player.weapon.img.h / 2,
            angle,
            true);
    }
    click = null;
}

function update(ms) {
    if (playerSelect || victory || levelIntro) {
        return;
    }
    if (player.hp <= 0) {
        playerSelect = true;
        level = 0;
        return;
    }
    if (enemies.length == 0) {
        if (level == levels.length - 1) {
            victory = true;
            level = 0;
            generateMap();
        } else {
            if (player.abilities.rosyCheeks) {
                player.hp = Math.min(player.type.hp, player.hp + 2);
            }
            level++;
            levelIntro = true;
            generateMap();
        }
        return;
    }
    if (player.xp > player.level && player.level < abilityNames.length - 3) {
        player.xp -= player.level + 1;
        player.level++;
        levelUp = true;
        availableAbilities = [];
        while (availableAbilities.length < 3) {
            var pick = abilityNames[Math.floor(Math.random() * abilityNames.length)];
            if (!player.abilities[pick] && availableAbilities.indexOf(pick) == -1) {
                availableAbilities.push(pick);
            }
        }
        return;
    }
    gunSwitchDelay = Math.max(gunSwitchDelay - ms, 0);
    gunTakeDelay = Math.max(gunTakeDelay - ms, 0);
    player.reload = Math.max(player.reload - ms, 0);
    player.abilityCooldown = Math.max(player.abilityCooldown - ms, 0);
    player.rageMeter = Math.max(player.rageMeter - ms, 0);
    player.mayhemMeter = Math.max(player.mayhemMeter - ms, 0);
    player.leaping = Math.max(player.leaping - ms, 0);
    
    if (player.mayhemMeter >= 30000 && player.hp < player.type.hp) {
        player.mayhemMeter = 0;
        player.hp++;
    }
    
    if (player.leaping) {
        var newX = player.x + player.leapDx * ms;
        var newY = player.y + player.leapDy * ms;
        var hitUnit = unitObstacleAt(newX, newY, player);
        if (hitUnit) {
            hitUnit.hp -= 4;
            hitUnit.lastHitBySpecialMove = true;
            for (var j = 0; j < 16; j++) {
                var a = Math.random() * Math.PI * 2;
                var spd = 0.05 + Math.random() * 0.3;
                particles.push({
                    color: "red",
                    x: hitUnit.x + TSZ / 2,
                    y: hitUnit.y + TSZ / 2,
                    dx: Math.cos(a) * spd,
                    dy: Math.sin(a) * spd,
                    r: 2 + Math.floor(Math.random() * 2),
                    life: 50 + Math.floor(Math.random() * 200)
                });
            }
            player.leaping = 0;
        } else if (wallAt(newX + 10, newY + 10) || wallAt(newX + TSZ - 10, newY + 10) || wallAt(newX + 10, newY - TSZ - 10) || wallAt(newX + TSZ - 10, newY + TSZ - 10)) {
            player.x -= player.leapDx * ms;
            player.y -= player.leapDy * ms;
            player.leaping = 0;
        } else {
            player.x = newX;
            player.y = newY;
        }
    }
    
    for (var i = 0; i < particles.length; i++) {
        var particle = particles[i];
        particle.x += particle.dx * ms;
        particle.y += particle.dy * ms;
        particle.life -= ms;
        if (particle.life <= 0) {
            particles.splice(i, 1);
            i--;
        }
    }
    for (var i = 0; i < drops.length; i++) {
        var drop = drops[i];
        if ((player.x + TSZ / 2 - drop.x) * (player.x + TSZ / 2 - drop.x) + (player.y + TSZ / 2 - drop.y) * (player.y + TSZ / 2 - drop.y) < 25 * 25) {
            switch (drop.type) {
                case "hp":
                    player.hp = Math.min(player.type.hp, player.hp + 1);
                    break;
                case "xp":
                    player.xp = player.xp + player.type.xpMult;
                    break;
                case "ammo":
                    player.ammo[drop.ammoType.id] = Math.min(drop.ammoType.max, player.ammo[drop.ammoType.id] + drop.ammoType.pickup);
                    break;
            }
            drop.life = 0;
        }
        drop.life -= ms;
        if (drop.life <= 0) {
            drops.splice(i, 1);
            i--;
        }
    }
    for (var i = 0; i < shots.length; i++) {
        var remove = false;
        var shot = shots[i];
        shot.x += shot.dx * ms;
        shot.y += shot.dy * ms;
        if (shot.weapon.fuze) {
            shot.fuze -= ms;
            if (shot.fuze <= 0) { remove = true; }
        } else {
            if ((shot.x - shot.srcX) * (shot.x - shot.srcX) + (shot.y - shot.srcY) * (shot.y - shot.srcY) > shot.weapon.range * shot.weapon.range) {
                remove = true;
            }
        }
        if (wallAt(shot.x, shot.y)) {
            if (shot.weapon.bounce) {
                if (wallAt(shot.x - shot.dx * ms, shot.y)) {
                    shot.dy *= -1;
                } else {
                    shot.dx *= -1;
                }
            } else {
                remove = true;
            }
        }
        var hitUnit = obstacleAt(shot.x, shot.y, null);
        if (hitUnit && (hitUnit == player) != shot.byPlayer) {
            if (shot.weapon.blastRadius == 0) {
                if (!shot.byPlayer && player.abilities.thickHide) {
                    hitUnit.hp -= shot.weapon.dmg - 1;                
                } else {
                    hitUnit.hp -= shot.weapon.dmg;
                }
                hitUnit.lastHitBySpecialMove = shot.weapon == weaponTypes.spurSpike || shot.weapon == weaponTypes.rageShooter;
                for (var j = 0; j < shot.weapon.dmg * 4; j++) {
                    var a = Math.random() * Math.PI * 2;
                    var spd = 0.05 + Math.random() * 0.3;
                    particles.push({
                        color: "red",
                        x: shot.x,
                        y: shot.y,
                        dx: Math.cos(a) * spd,
                        dy: Math.sin(a) * spd,
                        r: 2 + Math.floor(Math.random() * 2),
                        life: 50 + Math.floor(Math.random() * 200)
                    });
                }
            }
            remove = true;
        }
        if (remove) {
            if (shot.weapon.blastRadius) {
                particles.push({
                    color: "white",
                    x: shot.x,
                    y: shot.y,
                    dx: 0,
                    dy: 0,
                    r: shot.weapon.blastRadius,
                    life: 200
                });
                if (shot.byPlayer) {
                    for (var j = 0; j < enemies.length; j++) {
                        var enemy = enemies[j
                        ];
                        var dsq = (enemy.x + TSZ / 2 - shot.x) * (enemy.x + TSZ / 2 - shot.x) + (enemy.y + TSZ / 2 - shot.y) * (enemy.y + TSZ / 2 - shot.y);
                        if (dsq < shot.weapon.blastRadius * shot.weapon.blastRadius) {
                            enemy.hp -= shot.weapon.dmg;
                        }
                    }
                } else {
                    var dsq = (player.x - shot.x) * (player.x - shot.x) + (player.y - shot.y) * (player.y - shot.y);
                    if (dsq < shot.weapon.blastRadius * shot.weapon.blastRadius) {
                        player.hp -= shot.weapon.dmg;
                    }
                }
            }
            if (!hitUnit && shot.byPlayer && player.abilityCooldown == 0) {
                player.rageMeter += 7000;
            }
            shots.splice(i, 1);
            i--;
        }
    }
    for (var i = 0; i < enemies.length; i++) {
        var enemy = enemies[i];    
        enemy.reload = Math.max(0, enemy.reload - ms);
        enemy.moveWait = Math.max(0, enemy.moveWait - ms);
        enemy.stun = Math.max(0, enemy.stun - ms);
        if (enemy.stun > 0) { continue; }
        var distSq = (enemy.x - player.x) * (enemy.x - player.x) + (enemy.y - player.y) * (enemy.y - player.y);
        if (distSq < NOTICE_RANGE * NOTICE_RANGE) {
            enemy.noticed = true;
        }
        if (distSq > PURSUE_RANGE * PURSUE_RANGE) {
            enemy.noticed = false;
        }
        if (enemy.noticed) {
            var towardsPlayer = Math.atan2(player.y - enemy.y, player.x - enemy.x);
            var followRange = enemy.type.weapon.range * 0.6;
            if (distSq > followRange * followRange && enemy.moveWait == 0) {
                // Move towards the player.
                var newX = enemy.x + Math.cos(towardsPlayer) * enemy.type.speed * ms;
                var newY = enemy.y + Math.sin(towardsPlayer) * enemy.type.speed * ms;
                if (!wallAt(newX, newY) && !wallAt(newX + TSZ, newY) && !wallAt(newX, newY + TSZ) && !wallAt(newX + TSZ, newY + TSZ) && unitObstacleAt(newX, newY, enemy) == null) {
                    enemy.x = newX;
                    enemy.y = newY;
                } else {
                    enemy.moveWait = 500;
                }
            }
            if (distSq < enemy.type.weapon.range * enemy.type.weapon.range && enemy.reload == 0 && canHit(enemy.type.weapon, enemy, enemy.x + TSZ / 2, enemy.y + TSZ / 2, player.x + TSZ / 2, player.y + TSZ / 2)) {
                enemy.reload = enemy.type.weapon.reload;
                // Shoot at the player
                shoot(
                    enemy.type.weapon,
                    enemy.x + TSZ / 2,
                    enemy.y + TSZ / 2,
                    towardsPlayer,
                    false
                );
            }
        }
        if (enemy.hp <= 0) {
            if ((player.abilities.deathTrickPony && enemy.lastHitBySpecialMove) || Math.random() < enemy.type.dropP) {
                doDrop(enemy.x + TSZ / 2, enemy.y + TSZ / 2);
            }
            for (var j = 0; j < enemy.type.hp * 4; j++) {
                var a = Math.random() * Math.PI * 2;
                var spd = 0.05 + Math.random() * 0.3;
                particles.push({
                    color: "red",
                    x: enemy.x + TSZ / 2,
                    y: enemy.y + TSZ / 2,
                    dx: Math.cos(a) * spd,
                    dy: Math.sin(a) * spd,
                    r: 2 + Math.floor(Math.random() * 2),
                    life: 100 + Math.floor(Math.random() * 300)
                });
            }
            player.mayhemMeter += 5000;
            enemies.splice(i, 1);
            i--;
        }
    }
}

var graphicsImage = new Image();
graphicsImage.src = "gfx.png";

function img(img, x, y) {
    c.drawImage(graphicsImage, img.x, img.y, img.w, img.h, x, y, img.w, img.h);
}

function draw() {
    if (playerSelect) {
        c.fillStyle = "#905b35";
        c.fillRect(0, 0, canvas.width, canvas.height);
        img({x:7, y:689, w:528, h:168}, canvas.width / 2 - 528 / 2, 50);
        
        for (var i = 0; i < playerTypes.length; i++) {
            var pt = playerTypes[i];
            var hover = cursor.x >= 115 + i * 200 && cursor.x <= 115 + i * 200 + 170 && cursor.y >= 270 && cursor.y <= 270 + 290;
            c.fillStyle = hover ? "#c37b47" : "#5e3b23";
            c.fillRect(115 + i * 200, 270, 170, 290);
            img(pt.large, 120 + i * 200, 280);
            c.resetTransform(); 
            c.fillStyle = "white";
            c.font = "18px Monospace";
            c.fillText(pt.name, 125 + i * 200, 480);
            c.font = "14px Monospace";
            c.fillText(pt.desc0, 125 + i * 200, 520);
            c.fillText(pt.desc1, 125 + i * 200, 540);
        }
        
        c.fillStyle = "white";
        c.fillRect(cursor.x - 10, cursor.y - 1, 20, 2);
        c.fillRect(cursor.x - 1, cursor.y - 10, 2, 20);
        return;
    }
    if (levelUp) {
        c.fillStyle = "#905b35";
        c.fillRect(0, 0, canvas.width, canvas.height);
        c.fillStyle = "white";
        c.font = "18px Monospace";
        c.fillText("Level Up! Choose a new ability.", canvas.width / 2 - c.measureText("Level Up! Choose a new ability.").width / 2, 150);
        
        for (var i = 0; i < availableAbilities.length; i++) {
            var ab = abilities[availableAbilities[i]];
            var hover = cursor.x >= 115 + i * 200 && cursor.x <= 115 + i * 200 + 170 && cursor.y >= 270 && cursor.y <= 270 + 290;
            c.fillStyle = hover ? "#c37b47" : "#5e3b23";
            c.fillRect(115 + i * 200, 270, 170, 290);
            c.fillStyle = "white";
            c.font = "18px Monospace";
            c.fillText(ab.name, 125 + i * 200, 480);
            c.font = "14px Monospace";
            c.fillText(ab.desc0, 125 + i * 200, 520);
            c.fillText(ab.desc1, 125 + i * 200, 540);
        }
        
        c.fillStyle = "white";
        c.fillRect(cursor.x - 10, cursor.y - 1, 20, 2);
        c.fillRect(cursor.x - 1, cursor.y - 10, 2, 20);
        return;
    }
    if (victory) {
        c.fillStyle = "#905b35";
        c.fillRect(0, 0, canvas.width, canvas.height);
        img({x:320, y:160, w:160, h:160}, canvas.width / 2 - 80, 100);
        c.fillStyle = "white";
        c.font = "18px Monospace";
        var text = "Victory! With T.R.A.I.N defeated, a new era of peace begins.";
        c.fillText(text, canvas.width / 2 - c.measureText(text).width / 2, 400);
        return;
    }
    if (levelIntro) {
        c.fillStyle = "#905b35";
        c.fillRect(0, 0, canvas.width, canvas.height);
        img(levels[level].img, canvas.width / 2 - 80, 100);
        c.fillStyle = "white";
        c.font = "18px Monospace";
        var text = "Level " + (level + 1) + ": " + levels[level].name;
        c.fillText(text, canvas.width / 2 - c.measureText(text).width / 2, 400);
        return;
    }

    c.fillStyle = "#2e1d11";
    c.fillRect(0, 0, canvas.width, canvas.height);
    c.translate(canvas.width / 2 - player.x - TSZ / 2, canvas.height / 2 - player.y - TSZ / 2);
    for (var y = 0; y < MSZ; y++) { for (var x = 0; x < MSZ; x++) {
        if (map[y][x].dy == 0) {
            img(map[y][x].img, x * TSZ, y * TSZ);
        }
    }}
    for (var i = 0; i < drops.length; i++) {
        var drop = drops[i];
        img(drop.img, drop.x - drop.img.w / 2, drop.y - drop.img.h / 2);    
    }
    for (var i = 0; i < droppedWeapons.length; i++) {
        var droppedWeapon = droppedWeapons[i];
        img(droppedWeapon.type.img, droppedWeapon.x - droppedWeapon.type.img.w / 2, droppedWeapon.y - droppedWeapon.type.img.h / 2);
    }
    for (var i = 0; i < enemies.length; i++) {
        var enemy = enemies[i];
        img(enemy.type.img, enemy.x, enemy.y);    
    }
    img(player.type.img, player.x, player.y);
    for (var i = 0; i < shots.length; i++) {
        var shot = shots[i];
        c.translate(shot.x, shot.y);
        c.rotate(shot.angle);
        img(shot.weapon.shot, -shot.weapon.shot.w / 2, -shot.weapon.shot.h / 2);
        c.resetTransform();
        c.translate(canvas.width / 2 - player.x - TSZ / 2, canvas.height / 2 - player.y - TSZ / 2);
    }
    var weaponAngle = Math.atan2(cursor.y - canvas.height / 2, cursor.x - canvas.width / 2);
    c.translate(player.x + TSZ / 2, player.y + TSZ / 2);
    c.rotate(weaponAngle);
    img(player.weapon.img, 0, 0);
    c.resetTransform(); 
    c.translate(canvas.width / 2 - player.x - TSZ / 2, canvas.height / 2 - player.y - TSZ / 2);
    for (var i = 0; i < particles.length; i++) {
        var particle = particles[i];
        c.fillStyle = particle.color;
        //c.fillRect(particle.x - particle.r, particle.y - particle.r, particle.r * 2, particle.r * 2);
        c.beginPath();
        c.arc(particle.x, particle.y, particle.r, 0, Math.PI * 2);
        c.fill();
    }
    for (var y = 0; y < MSZ; y++) { for (var x = 0; x < MSZ; x++) {
        if (map[y][x].dy != 0) {
            img(map[y][x].img, x * TSZ, y * TSZ + map[y][x].dy);
        }
    }}
    for (var i = 0; i < droppedWeapons.length; i++) {
        var droppedWeapon = droppedWeapons[i];
        if (droppedWeapon.type != player.weapon && droppedWeapon.type != player.offHand && (player.x + TSZ / 2 - droppedWeapon.x) * (player.x + TSZ / 2 - droppedWeapon.x) + (player.y + TSZ / 2 - droppedWeapon.y) * (player.y + TSZ / 2 - droppedWeapon.y) < 25 * 25) {
            c.fillStyle = "white";
            c.font = "14px Monospace";
            c.fillText("Take " + droppedWeapon.type.name + " [E]", droppedWeapon.x, droppedWeapon.y - TSZ);
            break;
        }
    }
    c.resetTransform(); 
    c.fillStyle = "white";
    c.fillRect(cursor.x - 10, cursor.y - 1, 20, 2);
    c.fillRect(cursor.x - 1, cursor.y - 10, 2, 20);
    if (player.reload == 0) {
        c.fillRect(cursor.x - 5, cursor.y - 5, 10, 2);
        c.fillRect(cursor.x - 5, cursor.y - 5, 2, 10);
        c.fillRect(cursor.x + 3, cursor.y - 5, 2, 10);
        c.fillRect(cursor.x - 5, cursor.y + 3, 10, 2);
    }
    for (var i = 0; i < player.type.hp; i++) {
        img(i < player.hp ? {x:TSZ*2, y:TSZ*2, w:TSZ, h:TSZ} : {x:TSZ*3, y:TSZ*2, w:TSZ, h:TSZ}, 10 + 50 * i, 10);
    }
    var ammos = ["bullets", "grenades", "energy"];
    for (var i = 0; i < ammos.length; i++) {
        img(ammoTypes[ammos[i]].indicator, 10, 10 + TSZ + 10 + 20 * i);
        c.fillStyle = ammos[i] == player.weapon.ammo ? "yellow" : "white";
        c.font = "14px Monospace";
        c.fillText("" + player.ammo[ammos[i]], 35, 10 + TSZ + 10 + 20 * i + 9);
    }
    img(player.weapon.img, 70, 20 + TSZ);
    c.fillStyle = "yellow";
    c.font = "14px Monospace";
    c.fillText(player.weapon.name, 110, 20 + TSZ + 9);
    if (player.offHand) {
        img(player.offHand.img, 70, 20 + TSZ + 20);
        c.fillStyle = "white";
        c.fillText(player.offHand.name + " [Q]", 110, 20 + TSZ + 20 + 9);
    }
    if (player.type.name == "Taquito James") {
        c.fillStyle = "white";
        c.fillRect(10, 120, 200, 40);
        c.fillStyle = "#462415";
        c.fillRect(10 + 1, 120 + 1, 200 - 2, 40 - 2);
        c.fillStyle = "red";
        var amt = Math.min(1.0, player.rageMeter * 1.0 / 200000);
        if (player.abilityCooldown) {
            amt = Math.min(1.0, player.abilityCooldown * 1.0 / 10000);
        }
        c.fillRect(10 + 2, 120 + 2, (200 - 4) * amt, 40 - 4);
        c.fillStyle = "white";
        c.fillText(player.abilityCooldown ? "Rage!!!" : (amt >= 1 ? "Rage [Space]" : "Rage"), 20, 140 + 4);
    }
    if (player.abilities.mayhem) {
        var y = player.type.name == "Taquito James" ? 160 : 120;
        c.fillStyle = "white";
        c.fillRect(10, 120, 200, 40);
        c.fillStyle = "#462415";
        c.fillRect(10 + 1, 120 + 1, 200 - 2, 40 - 2);
        c.fillStyle = "red";
        var amt = Math.min(1.0, player.mayhemMeter * 1.0 / 30000);
        c.fillRect(10 + 2, 120 + 2, (200 - 4) * amt, 40 - 4);
        c.fillStyle = "white";
        c.fillText("Mayhem", 20, 140 + 4);
    }
    for (var i = 0; i < player.xp; i++) {
        img({x:30, y:124, w:10, h:10}, canvas.width - 20 - i * 15, 10);
    }
    c.fillStyle = "white";
    var levelText = "Level " + player.level;
    c.fillText(levelText, canvas.width - 10 - c.measureText(levelText).width, 49);
}


/** THE GAME "ENGINE" ********************************************************/
var canvas = document.getElementById("gameCanvas");
var c = canvas.getContext("2d");
var keys = {};
var click = null;
var mouseDown = false;
var cursor = {x: 300, y: 300};

// Listen for key presses.
function canvasKeyDown(e) {
    keys[String.fromCharCode(e.which)] = true;
}

function canvasKeyUp(e) {
    keys[String.fromCharCode(e.which)] = false;
}

function down(key) {
    return !!keys[key];
}

$('body').keydown(canvasKeyDown);
$('body').keyup(canvasKeyUp);

// Listen for mouse stuff.
function canvasClick(e) {
    click = { "x": e.offsetX, "y": e.offsetY };
}

function canvasMouseDown(e) {
    mouseDown = true;
}

function canvasMouseUp(e) {
    mouseDown = false;
}

function canvasMove(e) {
    cursor = { "x": e.offsetX, "y": e.offsetY };
}

$('#gameCanvas').click(canvasClick).mousemove(canvasMove).mousedown(canvasMouseDown).mouseup(canvasMouseUp);

// Set up game loop.
var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
var lastUpdate = new Date().getTime();

function nextFrame() {
    var currentTime = new Date().getTime();
    input(currentTime - lastUpdate);
    click = null;
    update(currentTime - lastUpdate);
    draw();
    lastUpdate = currentTime;
    requestAnimationFrame(nextFrame);
}

// Once everything is set up, start game loop.
requestAnimationFrame(nextFrame);
        </script>
    </body>
</html>
